# PFXFlow Specification Delta — Variable Propagation (run.toml → pfx_vars.tcl)
Version: Draft for integration after v0.8.1

---

## 1. Purpose

This delta defines the normative mechanism by which Design of Experiments (DOE)
variables and run-specific parameters are propagated from `run.toml` into
stage-local Tcl execution environments via `pfx_vars.tcl`.

This mechanism is owned by **PFXCore** and is mandatory for v1.

Wrappers SHALL NOT implement variable parsing or translation.

---

## 2. Responsibility Assignment

### 2.1 PFXStudy

PFXStudy SHALL:

- Generate `run.toml` for each leaf run directory.
- Populate all DOE axes, design identifiers, technology identifiers, and
  user-defined control variables.

### 2.2 PFXCore

PFXCore SHALL:

- Parse `run.toml` prior to executing each stage.
- Generate a stage-local Tcl variable file:
  
  ```
  <run_dir>/stages/<order>_<stage>/pfx_vars.tcl
  ```

- Optionally generate a stage entry script:
  
  ```
  <run_dir>/stages/<order>_<stage>/pfx_entry.tcl
  ```

- Ensure that `pfx_vars.tcl` is sourced before any user stage script executes.

### 2.3 Wrappers

Wrappers SHALL:

- Execute the Tcl entry script provided by PFXCore.
- NOT parse `run.toml`.
- NOT generate `pfx_vars.tcl`.

---

## 3. run.toml Variable Contract (v1)

`run.toml` SHALL contain the following top-level sections.

All sections are mandatory unless otherwise stated.

### 3.1 [run]

```toml
[run]
run_id        = "run_0001"
study_name    = "den_sweep"
semantic_path = "clock_ps=320/density=0.55"
created_utc   = "2026-02-05T14:22:00Z"
```

### 3.2 [doe]

DOE axis values.

```toml
[doe]
clock_ps = 320
density  = 0.55
```

### 3.3 [design]

```toml
[design]
name       = "my_design"
top        = "top_module"
filelist   = "resolved_inputs/design/filelist.f"
language   = "systemverilog"
```

### 3.4 [technology]

```toml
[technology]
bundle = "Z22"
corner = "typ"
```

### 3.5 [vars] (User Variables)

Optional user-defined variables.

```toml
[vars]
vt_flavor      = "LVT"
extra_effort   = true
max_fanout     = 32
target_slack   = -0.02
```

### 3.6 [paths] (Optional)

Optional resolved paths.

```toml
[paths]
reports_dir = "reports"
scratch_dir = "scratch"
```

---

## 4. Tcl Variable Generation Rules

PFXCore SHALL generate `pfx_vars.tcl` according to the following rules.

### 4.1 Namespace

All variables SHALL be placed in a single associative array:

```tcl
pfx(...)
```

### 4.2 Mapping Rules

| TOML Type | Tcl Representation |
|-----------|--------------------|
| Integer   | integer literal    |
| Float     | float literal      |
| String    | quoted string      |
| Boolean   | 0 / 1              |

### 4.3 Variable Names

Variables SHALL be named using:

```
pfx(<section>.<key>)
```

Example:

```
[doe]
clock_ps = 320
```

→

```
set pfx(doe.clock_ps) 320
```

### 4.4 Reserved Variables

PFXCore SHALL always generate:

```
pfx(run.run_id)
pfx(run.study_name)
pfx(run.semantic_path)
```

---

## 5. pfx_vars.tcl Format

### 5.1 Header

Each file SHALL begin with:

```tcl
# Auto-generated by PFXCore
# Source: run.toml
# Do not edit
```

### 5.2 Content

Each variable SHALL be generated as:

```tcl
set pfx(<name>) <value>
```

---

## 6. Optional Entry Script (pfx_entry.tcl)

If enabled, PFXCore SHALL generate:

```tcl
# Auto-generated entry script

source pfx_vars.tcl
source scripts/<stage>.tcl
```

Wrappers SHALL execute this script instead of the raw user script.

---

## 7. Full Example

### 7.1 Example run.toml

```toml
[run]
run_id        = "run_0001"
study_name    = "den_sweep"
semantic_path = "clock_ps=320/density=0.55"
created_utc   = "2026-02-05T14:22:00Z"

[doe]
clock_ps = 320
density  = 0.55

[design]
name     = "aes_core"
top      = "aes_top"
filelist = "resolved_inputs/design/filelist.f"
language = "systemverilog"

[technology]
bundle = "Z22"
corner = "typ"

[vars]
vt_flavor    = "LVT"
extra_effort = true
max_fanout   = 32
target_slack = -0.02
```

### 7.2 Generated pfx_vars.tcl

```tcl
# Auto-generated by PFXCore
# Source: run.toml
# Do not edit

set pfx(run.run_id) "run_0001"
set pfx(run.study_name) "den_sweep"
set pfx(run.semantic_path) "clock_ps=320/density=0.55"

set pfx(doe.clock_ps) 320
set pfx(doe.density) 0.55

set pfx(design.name) "aes_core"
set pfx(design.top) "aes_top"
set pfx(design.filelist) "resolved_inputs/design/filelist.f"
set pfx(design.language) "systemverilog"

set pfx(technology.bundle) "Z22"
set pfx(technology.corner) "typ"

set pfx(vars.vt_flavor) "LVT"
set pfx(vars.extra_effort) 1
set pfx(vars.max_fanout) 32
set pfx(vars.target_slack) -0.02
```

---

## 8. Compliance

Any implementation of PFXCore claiming v1 compliance SHALL implement this
variable propagation mechanism.

Wrappers that depend on environment variables or custom parsing are non-compliant.

---
